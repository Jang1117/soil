<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Soil Data Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body {height:100%; margin:0; padding:0; font-family: Arial, sans-serif;}
        #map-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }
        #map-left, #map-right {height:100%; width:50%;}
        #map-left {border-right: 3px solid black;}
        
        #legend-left {
            position: fixed;
            top: 80px; /* 지도 컨트롤 버튼 아래로 이동 */
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 12px;
            max-width: 280px;
        }
        #legend-right {
            position: fixed;
            top: 80px; /* 지도 컨트롤 버튼 아래로 이동 */
            left: calc(50% + 20px);
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 12px;
            max-width: 280px;
        }
        #legend-left h3, #legend-right h3 {margin: 0 0 10px 0; font-size: 14px; color: #333;}
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 3px 0;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #333;
            flex-shrink: 0;
        }
        .legend-text {
            font-size: 11px;
        }

        .controls {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 250px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        .control-group:last-child {
            margin-bottom: 0;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 13px;
        }
        
        select, button {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 5px;
        }
        
        button:hover {
            background: #45a049;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.3);
            z-index: 2000;
        }

        .info-window {
            max-width: 350px;
        }
        .info-window h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .info-window table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .info-window th, .info-window td {
            padding: 4px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .info-window th {
            background: #f5f5f5;
            font-weight: bold;
        }
        .criteria-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            color: white;
        }
    </style>
</head>
<body>
    <div id="loading">데이터를 불러오는 중...</div>
    
    <div id="legend-left">
        <h3 id="legend-title-left">pH 범위</h3>
        <div id="legend-content-left">
            <!-- 동적으로 생성됩니다 -->
        </div>
    </div>
    
    <div id="legend-right">
        <h3 id="legend-title-right">pH 범위</h3>
        <div id="legend-content-right">
            <!-- 동적으로 생성됩니다 -->
        </div>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label for="parameter-select">측정 항목:</label>
            <select id="parameter-select">
                <option value="pH">pH</option>
                <option value="C_organik">유기탄소 (C_organik) %</option>
                <option value="N_total">전질소 (N_total) %</option>
                <option value="P2O5_tersedia">유효인산 (P2O5_tersedia) mg/kg</option>
                <option value="Kalium K">칼륨 (K) cmol/kg</option>
                <option value="Natrium Na">나트륨 (Na) cmol/kg</option>
                <option value="Calcium Ca">칼슘 (Ca) cmol/kg</option>
                <option value="Magnesium Mg">마그네슘 (Mg) cmol/kg</option>
                <option value="KTK">양이온교환용량 (KTK) cmol/kg</option>
                <option value="Kejenuhan_Basa">염기포화도 %</option>
                <option value="Tembaga Cu">구리 (Cu) mg/kg</option>
                <option value="Besi Fe">철 (Fe) mg/kg</option>
                <option value="Mangan Mn">망간 (Mn) mg/kg</option>
                <option value="Seng Zn">아연 (Zn) mg/kg</option>
                <option value="K2O">K2O %</option>
                <option value="Al-dd">Al-dd cmol/kg</option>
                <option value="N_tersedia_NH4">유효질소 NH4 mg/kg</option>
                <option value="P2O5_total">전인산 P2O5 mg/kg</option>
            </select>
        </div>
    </div>
    
    <div id="map-container">
        <div id="map-left"></div>
        <div id="map-right"></div>
    </div>

    <script>
        let mapLeft, mapRight;
        let markersLeft = [];
        let markersRight = [];
        let soilData = [];
        let currentParameter = 'pH';
        let infoWindowLeft, infoWindowRight;

        // 토양 매개변수 기준표
        const soilCriteria = {
            'C_organik': {
                name: '유기탄소',
                unit: '%',
                ranges: [
                    {min: 0, max: 1.00, label: '매우 낮음', color: '#8B0000'},
                    {min: 1.00, max: 2.00, label: '낮음', color: 'red'},
                    {min: 2.01, max: 3.00, label: '보통', color: 'orange'},
                    {min: 3.01, max: 5.00, label: '높음', color: 'green'},
                    {min: 5.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'N_total': {
                name: '전질소',
                unit: '%',
                ranges: [
                    {min: 0, max: 0.10, label: '매우 낮음', color: '#8B0000'},
                    {min: 0.10, max: 0.20, label: '낮음', color: 'red'},
                    {min: 0.21, max: 0.50, label: '보통', color: 'orange'},
                    {min: 0.51, max: 0.75, label: '높음', color: 'green'},
                    {min: 0.76, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'P2O5_tersedia': {
                name: '유효인산',
                unit: 'mg/kg',
                ranges: [
                    {min: 0, max: 10, label: '매우 낮음', color: '#8B0000'},
                    {min: 10, max: 20, label: '낮음', color: 'red'},
                    {min: 21, max: 40, label: '보통', color: 'orange'},
                    {min: 41, max: 60, label: '높음', color: 'green'},
                    {min: 61, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'Kalium K': {
                name: '칼륨',
                unit: 'cmol/kg',
                ranges: [
                    {min: 0, max: 0.1, label: '매우 낮음', color: '#8B0000'},
                    {min: 0.1, max: 0.29, label: '낮음', color: 'red'},
                    {min: 0.3, max: 0.59, label: '보통', color: 'orange'},
                    {min: 0.6, max: 1, label: '높음', color: 'green'},
                    {min: 1.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'Natrium Na': {
                name: '나트륨',
                unit: 'cmol/kg',
                ranges: [
                    {min: 0, max: 0.1, label: '매우 낮음', color: '#8B0000'},
                    {min: 0.1, max: 0.39, label: '낮음', color: 'red'},
                    {min: 0.4, max: 0.79, label: '보통', color: 'orange'},
                    {min: 0.8, max: 1, label: '높음', color: 'green'},
                    {min: 1.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'Calcium Ca': {
                name: '칼슘',
                unit: 'cmol/kg',
                ranges: [
                    {min: 0, max: 2, label: '매우 낮음', color: '#8B0000'},
                    {min: 2, max: 5.99, label: '낮음', color: 'red'},
                    {min: 6, max: 10.99, label: '보통', color: 'orange'},
                    {min: 11, max: 20, label: '높음', color: 'green'},
                    {min: 20.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'Magnesium Mg': {
                name: '마그네슘',
                unit: 'cmol/kg',
                ranges: [
                    {min: 0, max: 0.4, label: '매우 낮음', color: '#8B0000'},
                    {min: 0.4, max: 1.09, label: '낮음', color: 'red'},
                    {min: 1.1, max: 2.09, label: '보통', color: 'orange'},
                    {min: 2.1, max: 8, label: '높음', color: 'green'},
                    {min: 8.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'KTK': {
                name: '양이온교환용량',
                unit: 'cmol/kg',
                ranges: [
                    {min: 0, max: 5, label: '매우 낮음', color: '#8B0000'},
                    {min: 5, max: 16, label: '낮음', color: 'red'},
                    {min: 17, max: 24, label: '보통', color: 'orange'},
                    {min: 24, max: 40, label: '높음', color: 'green'},
                    {min: 40.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'Kejenuhan_Basa': {
                name: '염기포화도',
                unit: '%',
                ranges: [
                    {min: 0, max: 20, label: '매우 낮음', color: '#8B0000'},
                    {min: 20, max: 35, label: '낮음', color: 'red'},
                    {min: 36, max: 50, label: '보통', color: 'orange'},
                    {min: 51, max: 70, label: '높음', color: 'green'},
                    {min: 70.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'Tembaga Cu': {
                name: '구리',
                unit: 'mg/kg',
                ranges: [
                    {min: 0, max: 0.2, label: '낮음', color: 'red'},
                    {min: 0.2, max: 0.2, label: '보통', color: 'orange'},
                    {min: 0.201, max: Infinity, label: '높음', color: 'green'}
                ]
            },
            'Besi Fe': {
                name: '철',
                unit: 'mg/kg',
                ranges: [
                    {min: 0, max: 2.5, label: '낮음', color: 'red'},
                    {min: 2.5, max: 4.5, label: '보통', color: 'orange'},
                    {min: 4.51, max: Infinity, label: '높음', color: 'green'}
                ]
            },
            'Mangan Mn': {
                name: '망간',
                unit: 'mg/kg',
                ranges: [
                    {min: 0, max: 1, label: '낮음', color: 'red'},
                    {min: 1, max: 1, label: '보통', color: 'orange'},
                    {min: 1.01, max: Infinity, label: '높음', color: 'green'}
                ]
            },
            'Seng Zn': {
                name: '아연',
                unit: 'mg/kg',
                ranges: [
                    {min: 0, max: 0.5, label: '낮음', color: 'red'},
                    {min: 0.5, max: 1.0, label: '보통', color: 'orange'},
                    {min: 1.01, max: Infinity, label: '높음', color: 'green'}
                ]
            },
            'K2O': {
                name: 'K2O',
                unit: '%',
                ranges: [
                    {min: 0, max: 0.03, label: '매우 낮음', color: '#8B0000'},
                    {min: 0.03, max: 0.06, label: '낮음', color: 'red'},
                    {min: 0.07, max: 0.11, label: '보통', color: 'orange'},
                    {min: 0.12, max: 0.2, label: '높음', color: 'green'},
                    {min: 0.21, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'Al-dd': {
                name: 'Al-dd',
                unit: 'cmol/kg',
                ranges: [
                    {min: 0, max: 15, label: '매우 낮음', color: '#8B0000'},
                    {min: 15, max: 20, label: '낮음', color: 'red'},
                    {min: 21, max: 30, label: '보통', color: 'orange'},
                    {min: 31, max: 60, label: '높음', color: 'green'},
                    {min: 60.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'N_tersedia_NH4': {
                name: '유효질소 NH4',
                unit: 'mg/kg',
                ranges: [
                    {min: 0, max: 10, label: '매우 낮음', color: '#8B0000'},
                    {min: 10, max: 30, label: '낮음', color: 'red'},
                    {min: 31, max: 60, label: '보통', color: 'orange'},
                    {min: 61, max: 100, label: '높음', color: 'green'},
                    {min: 101, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'P2O5_total': {
                name: '전인산 P2O5',
                unit: 'mg/kg',
                ranges: [
                    {min: 0, max: 50, label: '매우 낮음', color: '#8B0000'},
                    {min: 50, max: 100, label: '낮음', color: 'red'},
                    {min: 101, max: 200, label: '보통', color: 'orange'},
                    {min: 201, max: 400, label: '높음', color: 'green'},
                    {min: 401, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'pH': {
                name: 'pH',
                unit: '',
                ranges: [
                    {min: 0, max: 4.0, label: '매우 산성', color: 'red'},
                    {min: 4.0, max: 4.5, label: '중간 산성', color: 'orange'},
                    {min: 4.5, max: 5.5, label: '약산성', color: 'green'},
                    {min: 5.5, max: Infinity, label: '중성 근처', color: 'blue'}
                ]
            }
        };

        // JSON 파일 로드
        async function loadSoilData() {
            try {
                const response = await fetch('soil_full_no_texture.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                soilData = await response.json();
                document.getElementById('loading').style.display = 'none';
                console.log(`${soilData.length} 개의 토양 샘플을 로드했습니다.`);
                updateVisualization();
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                document.getElementById('loading').innerHTML = '데이터 로드에 실패했습니다.<br>soil_full_no_texture.json 파일이 있는지 확인해주세요.';
            }
        }

        function calculateCenter() {
            if (soilData.length === 0) return {lat: -2.84, lng: 133.08};
            const valid = soilData.filter(s => s.lat && s.lng);
            if (valid.length === 0) return {lat: -2.84, lng: 133.08};
            const sum = valid.reduce((acc, s) => ({
                lat: acc.lat + s.lat,
                lng: acc.lng + s.lng
            }), {lat: 0, lng: 0});
            return {lat: sum.lat / valid.length, lng: sum.lng / valid.length};
        }

        function getParameterValue(sample, depth, parameter) {
            if (sample[depth] && sample[depth][parameter] !== undefined) {
                return sample[depth][parameter];
            }
            return null;
        }

        function getColorAndCriteriaForParameter(value, parameter) {
            if (value === null || !soilCriteria[parameter]) {
                return {color: "gray", criteria: "데이터 없음"};
            }
            
            const ranges = soilCriteria[parameter].ranges;
            for (let range of ranges) {
                if (value >= range.min && value <= range.max) {
                    return {color: range.color, criteria: range.label};
                }
            }
            
            return {color: "gray", criteria: "범위 외"};
        }

        function updateLegend(parameter, side) {
            const titleId = side === 'left' ? 'legend-title-left' : 'legend-title-right';
            const contentId = side === 'left' ? 'legend-content-left' : 'legend-content-right';
            const title = document.getElementById(titleId);
            const content = document.getElementById(contentId);
            
            const criteria = soilCriteria[parameter];
            if (!criteria) return;
            
            const depthLabel = side === 'left' ? '0-20cm' : '20-40cm';
            title.textContent = `${criteria.name} (${criteria.unit}) - ${depthLabel}`;
            
            let legendHTML = '';
            criteria.ranges.forEach(range => {
                let rangeText = '';
                if (range.max === Infinity) {
                    rangeText = `> ${range.min}`;
                } else if (range.min === range.max) {
                    rangeText = `${range.min}`;
                } else {
                    rangeText = `${range.min} - ${range.max}`;
                }
                
                legendHTML += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${range.color};"></div>
                        <span class="legend-text">${rangeText} (${range.label})</span>
                    </div>
                `;
            });
            
            content.innerHTML = legendHTML;
        }

        function updateMarkers(side) {
            const map = side === 'left' ? mapLeft : mapRight;
            const markers = side === 'left' ? markersLeft : markersRight;
            const depth = side === 'left' ? 'depth_0_20' : 'depth_20_40';

            // 기존 마커 제거
            markers.forEach(m => m.setMap(null));
            markers.splice(0); // 배열 비우기

            soilData.forEach(sample => {
                const value = getParameterValue(sample, depth, currentParameter);
                if (value === null) return; // 값이 없으면 스킵

                const colorAndCriteria = getColorAndCriteriaForParameter(value, currentParameter);

                const marker = new google.maps.Marker({
                    position: {lat: sample.lat, lng: sample.lng},
                    map: map,
                    label: {
                        text: value.toFixed(2),
                        fontSize: "10px",
                        fontWeight: "bold",
                        color: "#fff"
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 16,
                        fillColor: colorAndCriteria.color,
                        fillOpacity: 0.8,
                        strokeWeight: 2,
                        strokeColor: "#333"
                    },
                    title: `Sample #${sample.no}: ${currentParameter} ${value} (${colorAndCriteria.criteria})`
                });

                // 클릭 이벤트 - 상세 정보 표시
                marker.addListener("click", () => {
                    showSampleInfo(sample, marker, side, depth);
                });

                markers.push(marker);
            });
        }

        function getCriteriaBadgeStyle(criteria) {
            const colorMap = {
                '매우 낮음': '#8B0000',
                '낮음': 'red',
                '보통': 'orange',
                '높음': 'green',
                '매우 높음': 'blue',
                '매우 산성': 'red',
                '중간 산성': 'orange',
                '약산성': 'green',
                '중성 근처': 'blue'
            };
            
            const bgColor = colorMap[criteria] || 'gray';
            return `background-color: ${bgColor};`;
        }

        function showSampleInfo(sample, marker, side, depth) {
            const depthLabel = depth === 'depth_0_20' ? '0-20cm' : '20-40cm';
            const data = sample[depth];
            const map = side === 'left' ? mapLeft : mapRight;
            let infoWindow = side === 'left' ? infoWindowLeft : infoWindowRight;
            
            if (!data) {
                const content = `
                    <div class="info-window">
                        <h4>Sample #${sample.no}</h4>
                        <p><strong>위치:</strong> ${sample.lat.toFixed(6)}, ${sample.lng.toFixed(6)}</p>
                        <p><strong>토층:</strong> ${depthLabel}</p>
                        <p>이 토층의 데이터가 없습니다.</p>
                    </div>
                `;
                
                if (infoWindow) infoWindow.close();
                infoWindow = new google.maps.InfoWindow({content: content});
                infoWindow.open(map, marker);
                if (side === 'left') infoWindowLeft = infoWindow;
                else infoWindowRight = infoWindow;
                return;
            }
            
            let tableRows = '';
            
            Object.keys(data).forEach(key => {
                if (data[key] !== null && data[key] !== undefined) {
                    const colorAndCriteria = getColorAndCriteriaForParameter(data[key], key);
                    const unit = soilCriteria[key] ? soilCriteria[key].unit : '';
                    const badgeStyle = getCriteriaBadgeStyle(colorAndCriteria.criteria);
                    
                    tableRows += `
                        <tr>
                            <th>${key} ${unit}</th>
                            <td>${data[key]} 
                                <span class="criteria-badge" style="${badgeStyle}">${colorAndCriteria.criteria}</span>
                            </td>
                        </tr>
                    `;
                }
            });

            const content = `
                <div class="info-window">
                    <h4>Sample #${sample.no}</h4>
                    <p><strong>위치:</strong> ${sample.lat.toFixed(6)}, ${sample.lng.toFixed(6)}</p>
                    <p><strong>토층:</strong> ${depthLabel}</p>
                    <table>
                        <tr><th>항목</th><th>값 및 평가</th></tr>
                        ${tableRows}
                    </table>
                </div>
            `;

            if (infoWindow) {
                infoWindow.close();
            }
            
            infoWindow = new google.maps.InfoWindow({
                content: content,
                maxWidth: 400
            });
            
            infoWindow.open(map, marker);
            if (side === 'left') infoWindowLeft = infoWindow;
            else infoWindowRight = infoWindow;
        }

        function updateVisualization() {
            currentParameter = document.getElementById('parameter-select').value;
            updateLegend(currentParameter, 'left');
            updateLegend(currentParameter, 'right');
            updateMarkers('left');
            updateMarkers('right');
        }

        function showHome() {
            const center = calculateCenter();
            mapLeft.setCenter(center);
            mapLeft.setZoom(10);
            mapRight.setCenter(center);
            mapRight.setZoom(10);
        }

        // 구글 지도 초기화
        window.initMap = function() {
            const center = calculateCenter();
            mapLeft = new google.maps.Map(document.getElementById("map-left"), {
                center: center,
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            mapRight = new google.maps.Map(document.getElementById("map-right"), {
                center: center,
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            // 파라미터 변경 이벤트
            document.getElementById('parameter-select').addEventListener('change', updateVisualization);
            
            // 데이터 로드
            loadSoilData();
        };

        // 지도 API 로드
        const script = document.createElement("script");
        script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyBKZ64N6aTmQLaU312nCqXeyrNa-lol2IQ&callback=initMap";
        script.async = true;
        document.head.appendChild(script);
    </script>
</body>
</html>
