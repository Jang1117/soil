<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Soil Data Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body {height:100%; margin:0; padding:0; font-family: Arial, sans-serif;}
        #map {height:100vh; width:100%;}
        
        #legend {
            position: fixed;
            top: 80px; /* 지도 컨트롤 버튼 아래로 이동 */
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 12px;
            max-width: 280px;
        }
        #legend h3 {margin: 0 0 10px 0; font-size: 14px; color: #333;}
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 3px 0;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #333;
            flex-shrink: 0;
        }
        .legend-text {
            font-size: 11px;
        }

        .controls {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 280px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        .control-group:last-child {
            margin-bottom: 0;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 13px;
        }
        
        select, button {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 5px;
        }
        
        button:hover {
            background: #45a049;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.3);
            z-index: 2000;
        }

        .info-window {
            max-width: 380px;
        }
        .info-window h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .info-window table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .info-window th, .info-window td {
            padding: 4px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .info-window th {
            background: #f5f5f5;
            font-weight: bold;
        }
        .criteria-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            color: white;
        }
    </style>
</head>
<body>
    <div id="loading">데이터를 불러오는 중...</div>
    
    <div id="legend">
        <h3 id="legend-title">pH 범위</h3>
        <div id="legend-content">
            <!-- 동적으로 생성됩니다 -->
        </div>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label for="depth-select">토층 깊이:</label>
            <select id="depth-select">
                <option value="avg_0_40">평균 (0-40cm)</option>
                <option value="depth_0_20">0-20cm</option>
                <option value="depth_20_40">20-40cm</option>
                
            </select>
        </div>
        
        <div class="control-group">
            <label for="parameter-select">측정 항목:</label>
            <select id="parameter-select">
                <option value="pH">pH</option>
                <option value="C_organik">유기탄소 (C_organik) %</option>
                <option value="N_total">전질소 (N_total) %</option>
                <option value="C_N_ratio">C/N 비</option>
                <option value="P2O5_tersedia">유효인산 (P2O5_tersedia) mg/100g</option>
                <option value="Kalium K">칼륨 (K) me/100g</option>
                <option value="Natrium Na">나트륨 (Na) me/100g</option>
                <option value="Calcium Ca">칼슘 (Ca) me/100g</option>
                <option value="Magnesium Mg">마그네슘 (Mg) me/100g</option>
                <option value="KTK">양이온교환용량 (KTK) me/100g</option>
                <option value="Kejenuhan_Basa">염기포화도 %</option>
                <option value="Tembaga Cu">구리 (Cu) mg/100g</option>
                <option value="Besi Fe">철 (Fe) mg/100g</option>
                <option value="Mangan Mn">망간 (Mn) mg/100g</option>
                <option value="Seng Zn">아연 (Zn) mg/100g</option>
                <option value="K2O">K2O mg/100g</option>
                <option value="Al-dd">Al-dd cmol/kg</option>
                <option value="N_tersedia_NH4">유효질소 NH4 mg/100g</option>
                <option value="P2O5_total">전인산 P2O5 mg/100g</option>
                <option value="Sulfur">황 (Sulfur) ppm</option>
            </select>
        </div>
        
        <!-- <div class="control-group">
            <button onclick="showHome()">전체 보기</button>
            <button onclick="updateVisualization()">업데이트</button>
        </div> -->
    </div>
    
    <div id="map"></div>

    <script>
        let map;
        let markers = [];
        let soilData = [];
        let currentDepth = 'depth_0_20';
        let currentParameter = 'pH';
        let infoWindow;

        // 토양 매개변수 기준표 (범위는 필요 시 조정하세요)
        const soilCriteria = {
            'C_organik': {
                name: '유기탄소',
                unit: '%',
                ranges: [
                    {min: 0, max: 1.00, label: '매우 낮음', color: '#8B0000'},
                    {min: 1.00, max: 2.00, label: '낮음', color: 'red'},
                    {min: 2.01, max: 3.00, label: '보통', color: 'orange'},
                    {min: 3.01, max: 5.00, label: '높음', color: 'green'},
                    {min: 5.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'N_total': {
                name: '전질소',
                unit: '%',
                ranges: [
                    {min: 0, max: 0.10, label: '매우 낮음', color: '#8B0000'},
                    {min: 0.10, max: 0.20, label: '낮음', color: 'red'},
                    {min: 0.21, max: 0.50, label: '보통', color: 'orange'},
                    {min: 0.51, max: 0.75, label: '높음', color: 'green'},
                    {min: 0.76, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'C_N_ratio': {
                name: 'C/N 비',
                unit: '',
                ranges: [
                    {min: 0, max: 5, label: '매우 낮음', color: '#8B0000'},
                    {min: 5, max: 10, label: '낮음', color: 'red'},
                    {min: 10.01, max: 20, label: '보통', color: 'orange'},
                    {min: 20.01, max: 30, label: '높음', color: 'green'},
                    {min: 30.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'P2O5_tersedia': {
                name: '유효인산',
                unit: 'mg/100g',
                ranges: [
                    {min: 0, max: 10, label: '매우 낮음', color: '#8B0000'},
                    {min: 10, max: 20, label: '낮음', color: 'red'},
                    {min: 21, max: 40, label: '보통', color: 'orange'},
                    {min: 41, max: 60, label: '높음', color: 'green'},
                    {min: 61, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'Kalium K': {
                name: '칼륨',
                unit: 'cmol/kg',
                ranges: [
                    {min: 0, max: 0.1, label: '매우 낮음', color: '#8B0000'},
                    {min: 0.1, max: 0.29, label: '낮음', color: 'red'},
                    {min: 0.3, max: 0.59, label: '보통', color: 'orange'},
                    {min: 0.6, max: 1, label: '높음', color: 'green'},
                    {min: 1.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'Natrium Na': {
                name: '나트륨',
                unit: 'me/100g',
                ranges: [
                    {min: 0, max: 0.1, label: '매우 낮음', color: '#8B0000'},
                    {min: 0.1, max: 0.39, label: '낮음', color: 'red'},
                    {min: 0.4, max: 0.79, label: '보통', color: 'orange'},
                    {min: 0.8, max: 1, label: '높음', color: 'green'},
                    {min: 1.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'Calcium Ca': {
                name: '칼슘',
                unit: 'me/100g',
                ranges: [
                    {min: 0, max: 2, label: '매우 낮음', color: '#8B0000'},
                    {min: 2, max: 5.99, label: '낮음', color: 'red'},
                    {min: 6, max: 10.99, label: '보통', color: 'orange'},
                    {min: 11, max: 20, label: '높음', color: 'green'},
                    {min: 20.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'Magnesium Mg': {
                name: '마그네슘',
                unit: 'me/100g',
                ranges: [
                    {min: 0, max: 0.4, label: '매우 낮음', color: '#8B0000'},
                    {min: 0.4, max: 1.09, label: '낮음', color: 'red'},
                    {min: 1.1, max: 2.09, label: '보통', color: 'orange'},
                    {min: 2.1, max: 8, label: '높음', color: 'green'},
                    {min: 8.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'KTK': {
                name: '양이온교환용량',
                unit: 'me/100g',
                ranges: [
                    {min: 0, max: 5, label: '매우 낮음', color: '#8B0000'},
                    {min: 5, max: 16, label: '낮음', color: 'red'},
                    {min: 17, max: 24, label: '보통', color: 'orange'},
                    {min: 24, max: 40, label: '높음', color: 'green'},
                    {min: 40.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'Kejenuhan_Basa': {
                name: '염기포화도',
                unit: '%',
                ranges: [
                    {min: 0, max: 20, label: '매우 낮음', color: '#8B0000'},
                    {min: 20, max: 35, label: '낮음', color: 'red'},
                    {min: 36, max: 50, label: '보통', color: 'orange'},
                    {min: 51, max: 70, label: '높음', color: 'green'},
                    {min: 70.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'Tembaga Cu': {
                name: '구리',
                unit: 'mg/100g',
                ranges: [
                    {min: 0, max: 0.2, label: '낮음', color: 'red'},
                    {min: 0.2, max: 0.2, label: '보통', color: 'orange'},
                    {min: 0.201, max: Infinity, label: '높음', color: 'green'}
                ]
            },
            'Besi Fe': {
                name: '철',
                unit: 'mg/100g',
                ranges: [
                    {min: 0, max: 2.5, label: '낮음', color: 'red'},
                    {min: 2.5, max: 4.5, label: '보통', color: 'orange'},
                    {min: 4.51, max: Infinity, label: '높음', color: 'green'}
                ]
            },
            'Mangan Mn': {
                name: '망간',
                unit: 'mg/100g',
                ranges: [
                    {min: 0, max: 1, label: '낮음', color: 'red'},
                    {min: 1, max: 1, label: '보통', color: 'orange'},
                    {min: 1.01, max: Infinity, label: '높음', color: 'green'}
                ]
            },
            'Seng Zn': {
                name: '아연',
                unit: 'mg/100g',
                ranges: [
                    {min: 0, max: 0.5, label: '낮음', color: 'red'},
                    {min: 0.5, max: 1.0, label: '보통', color: 'orange'},
                    {min: 1.01, max: Infinity, label: '높음', color: 'green'}
                ]
            },
            'K2O': {
                name: 'K2O',
                unit: 'mg/100g',
                ranges: [
                    {min: 0, max: 0.03, label: '매우 낮음', color: '#8B0000'},
                    {min: 0.03, max: 0.06, label: '낮음', color: 'red'},
                    {min: 0.07, max: 0.11, label: '보통', color: 'orange'},
                    {min: 0.12, max: 0.2, label: '높음', color: 'green'},
                    {min: 0.21, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'Al-dd': {
                name: 'Al-dd',
                unit: 'cmol/kg',
                ranges: [
                    {min: 0, max: 15, label: '매우 낮음', color: '#8B0000'},
                    {min: 15, max: 20, label: '낮음', color: 'red'},
                    {min: 21, max: 30, label: '보통', color: 'orange'},
                    {min: 31, max: 60, label: '높음', color: 'green'},
                    {min: 60.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'N_tersedia_NH4': {
                name: '유효질소 NH4',
                unit: 'mg/100g',
                ranges: [
                    {min: 0, max: 10, label: '매우 낮음', color: '#8B0000'},
                    {min: 10, max: 30, label: '낮음', color: 'red'},
                    {min: 31, max: 60, label: '보통', color: 'orange'},
                    {min: 61, max: 100, label: '높음', color: 'green'},
                    {min: 101, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'P2O5_total': {
                name: '전인산 P2O5',
                unit: 'mg/kg',
                ranges: [
                    {min: 0, max: 50, label: '매우 낮음', color: '#8B0000'},
                    {min: 50, max: 100, label: '낮음', color: 'red'},
                    {min: 101, max: 200, label: '보통', color: 'orange'},
                    {min: 201, max: 400, label: '높음', color: 'green'},
                    {min: 401, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            },
            'pH': {
                name: 'pH',
                unit: '',
                ranges: [
                    {min: 0, max: 4.0, label: '매우 산성', color: 'red'},
                    {min: 4.0, max: 4.5, label: '중간 산성', color: 'orange'},
                    {min: 4.5, max: 5.5, label: '약산성', color: 'green'},
                    {min: 5.5, max: Infinity, label: '중성 근처', color: 'blue'}
                ]
            },
            'Sulfur': {
                name: '황',
                unit: 'ppm',
                ranges: [
                    {min: 0, max: 10, label: '매우 낮음', color: '#8B0000'},
                    {min: 10, max: 20, label: '낮음', color: 'red'},
                    {min: 21, max: 40, label: '보통', color: 'orange'},
                    {min: 41, max: 80, label: '높음', color: 'green'},
                    {min: 80.01, max: Infinity, label: '매우 높음', color: 'blue'}
                ]
            }
        };

        // JSON 파일 로드
        async function loadSoilData() {
            try {
                const response = await fetch('lab_results_structured.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                soilData = await response.json();
                document.getElementById('loading').style.display = 'none';
                console.log(`${soilData.length} 개의 토양 샘플을 로드했습니다.`);
                updateVisualization();
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                document.getElementById('loading').innerHTML = '데이터 로드에 실패했습니다.<br>lab_results_structured.json 파일이 있는지 확인해주세요.';
            }
        }

        function calculateCenter() {
            if (soilData.length === 0) return {lat: -2.84, lng: 133.08};
            const valid = soilData.filter(s => s.lat && s.lng);
            if (valid.length === 0) return {lat: -2.84, lng: 133.08};
            const sum = valid.reduce((acc, s) => ({
                lat: acc.lat + s.lat,
                lng: acc.lng + s.lng
            }), {lat: 0, lng: 0});
            return {lat: sum.lat / valid.length, lng: sum.lng / valid.length};
        }

        function averageDepthValue(sample, parameter) {
            // 평균(0-40cm): 사용 가능한 깊이만 평균 (둘 다 없으면 null)
            const depths = ['depth_0_20', 'depth_20_40'];
            const values = depths
                .map(d => sample[d] && typeof sample[d][parameter] === 'number' ? sample[d][parameter] : null)
                .filter(v => v !== null && !Number.isNaN(v));
            if (values.length === 0) return null;
            const sum = values.reduce((a, b) => a + b, 0);
            return sum / values.length;
        }

        function getParameterValue(sample, depth, parameter) {
            if (depth === 'avg_0_40') {
                return averageDepthValue(sample, parameter);
            }
            if (sample[depth] && sample[depth][parameter] !== undefined) {
                const v = sample[depth][parameter];
                return typeof v === 'number' ? v : null;
            }
            return null;
        }

        function getColorAndCriteriaForParameter(value, parameter) {
            if (value === null || !soilCriteria[parameter]) {
                return {color: 'gray', criteria: '데이터 없음'};
            }
            const ranges = soilCriteria[parameter].ranges;
            for (let range of ranges) {
                if (value >= range.min && value <= range.max) {
                    return {color: range.color, criteria: range.label};
                }
            }
            return {color: 'gray', criteria: '범위 외'};
        }

        function updateLegend(parameter) {
            const title = document.getElementById('legend-title');
            const content = document.getElementById('legend-content');
            
            const criteria = soilCriteria[parameter];
            if (!criteria) return;
            
            let depthLabel = '0-20cm';
            if (currentDepth === 'depth_20_40') depthLabel = '20-40cm';
            if (currentDepth === 'avg_0_40') depthLabel = '평균 (0-40cm)';

            title.textContent = `${criteria.name} (${criteria.unit}) - ${depthLabel}`;
            
            let legendHTML = '';
            criteria.ranges.forEach(range => {
                let rangeText = '';
                if (range.max === Infinity) {
                    rangeText = `> ${range.min}`;
                } else if (range.min === range.max) {
                    rangeText = `${range.min}`;
                } else {
                    rangeText = `${range.min} - ${range.max}`;
                }
                
                legendHTML += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${range.color};"></div>
                        <span class="legend-text">${rangeText} (${range.label})</span>
                    </div>
                `;
            });
            
            content.innerHTML = legendHTML;
        }

        function updateMarkers() {
            // 기존 마커 제거
            markers.forEach(m => m.setMap(null));
            markers = [];

            soilData.forEach(sample => {
                const value = getParameterValue(sample, currentDepth, currentParameter);
                if (value === null || Number.isNaN(value)) return; // 값이 없으면 스킵

                const colorAndCriteria = getColorAndCriteriaForParameter(value, currentParameter);

                const marker = new google.maps.Marker({
                    position: {lat: sample.lat, lng: sample.lng},
                    map: map,
                    label: {
                        text: (typeof value === 'number' ? value.toFixed(2) : String(value)),
                        fontSize: '10px',
                        fontWeight: 'bold',
                        color: '#fff'
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 16,
                        fillColor: colorAndCriteria.color,
                        fillOpacity: 0.8,
                        strokeWeight: 2,
                        strokeColor: '#333'
                    },
                    title: `Sample #${sample.no}: ${currentParameter} ${value} (${colorAndCriteria.criteria})`
                });

                // 클릭 이벤트 - 상세 정보 표시
                marker.addListener('click', () => {
                    showSampleInfo(sample, marker);
                });

                markers.push(marker);
            });
        }

        function getCriteriaBadgeStyle(criteria) {
            const colorMap = {
                '매우 낮음': '#8B0000',
                '낮음': 'red',
                '보통': 'orange',
                '높음': 'green',
                '매우 높음': 'blue',
                '매우 산성': 'red',
                '중간 산성': 'orange',
                '약산성': 'green',
                '중성 근처': 'blue'
            };
            
            const bgColor = colorMap[criteria] || 'gray';
            return `background-color: ${bgColor};`;
        }

        function showSampleInfo(sample, marker) {
            let depthLabel = '0-20cm';
            if (currentDepth === 'depth_20_40') depthLabel = '20-40cm';
            if (currentDepth === 'avg_0_40') depthLabel = '평균 (0-40cm)';

            const data0 = sample['depth_0_20'] || {};
            const data1 = sample['depth_20_40'] || {};
            
            let tableRows = '';
            const keys = new Set([
                ...Object.keys(data0),
                ...Object.keys(data1)
            ]);

            // 현재 선택된 깊이에 맞춰 값 표시 (평균 선택 시 평균값 표시)
            keys.forEach(key => {
                const unit = soilCriteria[key] ? soilCriteria[key].unit : '';
                let displayValue = null;
                if (currentDepth === 'avg_0_40') {
                    displayValue = averageDepthValue(sample, key);
                } else {
                    const src = currentDepth === 'depth_0_20' ? data0 : data1;
                    displayValue = typeof src[key] === 'number' ? src[key] : null;
                }
                if (displayValue === null || Number.isNaN(displayValue)) return;

                const colorAndCriteria = getColorAndCriteriaForParameter(displayValue, key);
                const badgeStyle = getCriteriaBadgeStyle(colorAndCriteria.criteria);
                
                tableRows += `
                    <tr>
                        <th>${key} ${unit}</th>
                        <td>${displayValue} 
                            <span class="criteria-badge" style="${badgeStyle}">${colorAndCriteria.criteria}</span>
                        </td>
                    </tr>
                `;
            });

            const content = `
                <div class="info-window">
                    <h4>Sample #${sample.no}</h4>
                    <p><strong>위치:</strong> ${sample.lat.toFixed(6)}, ${sample.lng.toFixed(6)}</p>
                    <p><strong>토층:</strong> ${depthLabel}</p>
                    <table>
                        <tr><th>항목</th><th>값 및 평가</th></tr>
                        ${tableRows}
                    </table>
                </div>
            `;

            if (infoWindow) {
                infoWindow.close();
            }
            
            infoWindow = new google.maps.InfoWindow({
                content: content,
                maxWidth: 420
            });
            
            infoWindow.open(map, marker);
        }

        function updateVisualization() {
            currentDepth = document.getElementById('depth-select').value;
            currentParameter = document.getElementById('parameter-select').value;
            updateLegend(currentParameter);
            updateMarkers();
        }

        function showHome() {
            map.setCenter(calculateCenter());
            map.setZoom(10);
        }

        // 구글 지도 초기화
        window.initMap = function() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: calculateCenter(),
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            // 파라미터 변경 이벤트
            document.getElementById('depth-select').addEventListener('change', updateVisualization);
            document.getElementById('parameter-select').addEventListener('change', updateVisualization);
            
            // 데이터 로드
            loadSoilData();
        };

        // 지도 API 로드
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBKZ64N6aTmQLaU312nCqXeyrNa-lol2IQ&callback=initMap';
        script.async = true;
        document.head.appendChild(script);
    </script>
</body>
</html>



